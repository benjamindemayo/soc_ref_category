---
title: "soc_ref_cat_analysis_2"
author: "Benjamin E. deMayo"
date: "March 8, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(psych)
library(langcog)
library(tidyverse)
library(stringr)
library(magrittr)

example_file <- "C:/Users/demay/Desktop/soc_ref_cat/analysis/raw_data/020218_01-eye_data Samples.txt"

example_trial_file <- "C:/Users/demay/Desktop/soc_ref_cat/analysis/trial_data/020218_01.csv"

demographics_sheet <- "soc_ref_cat_demo_final.csv"

key <- "trial_morphs.csv"
```

Preliminaries.

```{r eval = FALSE}
#read in trial data.

demographics <- read_csv(demographics_sheet)

trial_key <- read_csv(key)

d.trials <- data.frame()
files <- dir("trial_data")

for (f in files) {
  
  subj_id <- str_replace(f, ".csv", "")
  
  condition <- 
    demographics %>% 
    filter(`SID` == subj_id) %>% 
    pull("Condition")
  
  jf <- paste("trial_data/", f, sep = "")
  jd <- read_csv(jf)
  id <- 
    tibble(
      SID = subj_id, 
      trial = jd$Trial.Number,  
      onset = jd$Trial.onset / 1000,  
      offset = jd$Trial.offset / 1000
    ) %>%
    mutate(
      camera_onset = jd$camera.onset[1] / 1000,
      webcam_onset = jd$webcam.onset[1] / 1000,
      camera_lag = webcam_onset - camera_onset,
      webcam_length = jd$extcam_length.onset[1] / 1000,
      onset = onset + camera_lag,
      offset = offset + camera_lag,
      condition = condition
    ) %>% 
    left_join(
      trial_key, 
      by = c("trial" = "Trial", "condition" = "Condition")
    )
  d.trials <- bind_rows(d.trials, id)
  
}
```

```{r}
#This function reads in data that end in .txt

read.smi.idf <- function(file.name) {
  d <- 
    read_tsv(
    file.name, 
    comment = "##"
    ) %>% 
    filter(Type == "SMP") %>% 
    select(
      t = Time,
      lx = "L POR X [px]",
      rx = "R POR X [px]",
      ly = "L POR Y [px]",
      ry = "R POR Y [px]"
    ) %>% 
    mutate(sid = str_extract(file.name, "\\d{6}_\\d{2}"))
}
```

```{r}
################################################################################
## PREPROCESS DATA 
## take data file with l and r, x and y, as well as stimulus, average
## eyes, do whatever preprocessing needs to be done. 
################################################################################

preprocess.data <- function(d, x.max = 1920, y.max=1080, samp.rate = 30) {

  #Remove out of range looks
    d <- 
    d %>% 
    mutate(
      rx = if_else(rx <= 0 | rx >= x.max, NA_real_, rx),
      lx = if_else(lx <= 0 | lx >= x.max, NA_real_, lx),
      ry = if_else(ry <= 0 | ry >= y.max, NA_real_, ry),
      ly = if_else(ly <= 0 | ly >= y.max, NA_real_, ly)
    )

  #Take one eye if we only have one; otherwise average them
    d <-
      d %>%
      mutate(
        x = case_when(
          is.na(rx) & !is.na(lx) ~ lx,
          !is.na(rx) & is.na(lx) ~ rx,
          !is.na(rx) & !is.na(lx) ~ (rx + lx) / 2,
          is.na(rx) & is.na(lx) ~ NA_real_
        ),
        y = case_when(
          is.na(ry) & !is.na(ly) ~ ly,
          !is.na(ry) & is.na(ly) ~ ry,
          !is.na(ry) & !is.na(ly) ~ (ry + ly) / 2,
          is.na(ry) & is.na(ly) ~ NA_real_
        )
      ) %>%
      select(
        -rx, -ry, -lx, -ly
      ) %>%
      mutate(
        t = round((d$t - d$t[1])/(1000000), 3),
        y = y.max - y
      )
}
```

Read in experiment data and preprocess.
```{r}
raw.data.path <- "raw_data/"
processed.data.path <- "processed_data/"

## LOOP TO READ IN FILES
all.data <- data.frame()
files <- dir(raw.data.path,pattern = "*.txt")

to.n <- function(x) {as.numeric(as.character(x))}
sem <- function(x) {sd(x) / sqrt(length(x))}

for (file.name in files) {
  ## print file name, so if loop breaks, we know where
  print(file.name)
  exp_trials <-
    d.trials %>%
    filter(SID == str_extract(file.name, "\\d{6}_\\d{2}"))
  
  print(exp_trials)

  ## these are the two functions that are most meaningful
  d <- read.smi.idf(str_c(raw.data.path, file.name, sep = ""))
  d <- 
    preprocess.data(d, x.max = 1920, y.max = 1080, samp.rate = 30) 
  
  calibration_time <- d$t[nrow(d)] - exp_trials$webcam_length[1]
  
  d <-
    d %>% 
    mutate(t = t - calibration_time) %>% 
    filter(t >= 0)
  
  d <-
    d %>%
    mutate(trial = case_when(
      t >= (exp_trials %>% slice(1))$onset & 
        t <= (exp_trials %>% slice(1))$offset
      ~ 1,
      t >= (exp_trials %>% slice(2))$onset & 
        t <= (exp_trials %>% slice(2))$offset
      ~ 2,
      t >= (exp_trials %>% slice(3))$onset & 
        t <= (exp_trials %>% slice(3))$offset
      ~ 3,
      t >= (exp_trials %>% slice(4))$onset & 
        t <= (exp_trials %>% slice(4))$offset
      ~ 4,
      t >= (exp_trials %>% slice(5))$onset & 
        t <= (exp_trials %>% slice(5))$offset
      ~ 5,
      t >= (exp_trials %>% slice(6))$onset & 
        t <= (exp_trials %>% slice(6))$offset
      ~ 6,
      t >= (exp_trials %>% slice(7))$onset & 
        t <= (exp_trials %>% slice(7))$offset
      ~ 7,
      t >= (exp_trials %>% slice(8))$onset & 
        t <= (exp_trials %>% slice(8))$offset
      ~ 8,
      t >= (exp_trials %>% slice(9))$onset & 
        t <= (exp_trials %>% slice(9))$offset
      ~ 9,
      t >= (exp_trials %>% slice(10))$onset & 
        t <= (exp_trials %>% slice(10))$offset
      ~ 10,
      t >= (exp_trials %>% slice(11))$onset & 
        t <= (exp_trials %>% slice(11))$offset
      ~ 11,
      t >= (exp_trials %>% slice(12))$onset & 
        t <= (exp_trials %>% slice(12))$offset
      ~ 12,
      t >= (exp_trials %>% slice(13))$onset & 
        t <= (exp_trials %>% slice(13))$offset
      ~ 13,
      t >= (exp_trials %>% slice(14))$onset & 
        t <= (exp_trials %>% slice(14))$offset
      ~ 14,
      t >= (exp_trials %>% slice(15))$onset & 
        t <= (exp_trials %>% slice(15))$offset
      ~ 15,
      t >= (exp_trials %>% slice(16))$onset & 
        t <= (exp_trials %>% slice(16))$offset
      ~ 16,
      t >= (exp_trials %>% slice(17))$onset & 
        t <= (exp_trials %>% slice(17))$offset
      ~ 17,
      t >= (exp_trials %>% slice(18))$onset & 
        t <= (exp_trials %>% slice(18))$offset
      ~ 18,
      t >= (exp_trials %>% slice(19))$onset & 
        t <= (exp_trials %>% slice(19))$offset
      ~ 19,
      t >= (exp_trials %>% slice(20))$onset & 
        t <= (exp_trials %>% slice(20))$offset
      ~ 20,
      t >= (exp_trials %>% slice(21))$onset & 
        t <= (exp_trials %>% slice(21))$offset
      ~ 21,
      t >= (exp_trials %>% slice(22))$onset & 
        t <= (exp_trials %>% slice(22))$offset
      ~ 22,
      t >= (exp_trials %>% slice(23))$onset & 
        t <= (exp_trials %>% slice(23))$offset
      ~ 23,
      t >= (exp_trials %>% slice(24))$onset & 
        t <= (exp_trials %>% slice(24))$offset
      ~ 24,
      t >= (exp_trials %>% slice(25))$onset & 
        t <= (exp_trials %>% slice(25))$offset
      ~ 25,
      t >= (exp_trials %>% slice(26))$onset & 
        t <= (exp_trials %>% slice(26))$offset
      ~ 26,
      t >= (exp_trials %>% slice(27))$onset & 
        t <= (exp_trials %>% slice(27))$offset
      ~ 27,
      t >= (exp_trials %>% slice(28))$onset & 
        t <= (exp_trials %>% slice(28))$offset
      ~ 28
    )) %>% 
    left_join(
      d.trials %>% select(SID, trial, Morph),
      by = c("sid" = "SID", "trial")
    )
  
  
  ## now here's where data get bound togetherq
  all.data <- bind_rows(all.data, d)
}

write_csv(all.data, path = paste0(processed.data.path, "socref_cat_data.csv"))
```

```{r fig.height=10}
ggplot(all.data, aes(x = t, y = y)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~ trial, scales = "free_x")

trial_proportions <- 
  all.data %>% 
  filter(!is.na(trial)) %>% 
  group_by(sid, trial) %>% 
  mutate(
    trial_length = max(t) - min(t),
    look = !is.na(x) | !is.na(y)
  ) %>% 
  mutate(look = case_when(
    look ~ "looking",
    !look ~ "not_looking"
  )) %>% 
  count(sid, trial, look, Morph) %>% 
  spread(look, n) %>% 
  replace_na(list(looking = 0, not_looking = 0)) %>% 
  mutate(prop_looking = looking / (looking + not_looking))

morph_proportions <- 
  trial_proportions %>% 
  group_by(Morph) %>% 
  summarize(mean_prop_looking = mean(prop_looking))

morph_proportions %>% 
  ggplot(aes(as.factor(Morph), mean_prop_looking)) +
  geom_col()
  
  
  

# +
  #lims(x = c(0, 1920), y = c(0,1080))
```

```{r}
d %>% 
  filter(t >= 120, t <= 190) %>% 
  ggplot(aes(x = t, y = x)) +
  geom_point()
```


```{r}
trial_proportions <- 
  all.data %>% 
  filter(!is.na(trial)) %>% 
  group_by(sid, trial) %>% 
  mutate(
    trial_length = max(t) - min(t),
    look_captured = !is.na(x) | !is.na(y)
  ) %>% 
  mutate(look = case_when(
    look_captured ~ "looking",
    !look_captured ~ "not_looking"
  )) %>% 
  count(sid, trial, look, Morph) %>% 
  spread(look, n) %>% 
  replace_na(list(looking = 0, not_looking = 0)) %>% 
  mutate(prop_looking = looking / (looking + not_looking))

morph_proportions <- 
  trial_proportions %>% 
  group_by(Morph) %>% 
  summarize(mean_prop_looking = mean(prop_looking))

morph_proportions %>% 
  ggplot(aes(as.factor(Morph), mean_prop_looking)) +
  geom_col() +
  labs(
    x = "Morph",
    y = "Mean percentage of trial looking"
  ) +
  scale_y_continuous(labels = scales::percent)

morph_proportions_per_subject <-  
  trial_proportions %>% 
  group_by(sid, Morph) %>% 
  summarize(mean_prop_looking = mean(prop_looking))

morph_proportions_per_subject %>% 
  ggplot(aes(as.factor(Morph), mean_prop_looking)) +
  geom_col() +
  labs(
    x = "Morph",
    y = "Mean percentage of trial looking"
  ) +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~ sid)


  
  
```

